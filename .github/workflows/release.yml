name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  pull-requests: read

jobs:
  # Job 1: Validate the release tag
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      major-version: ${{ steps.get-version.outputs.major-version }}
      is-prerelease: ${{ steps.check-prerelease.outputs.is-prerelease }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: get-version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          MAJOR_VERSION=$(echo $VERSION | cut -d. -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major-version=$MAJOR_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
          echo "Major version: $MAJOR_VERSION"
      
      - name: Check if prerelease
        id: check-prerelease
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if [[ "$VERSION" =~ -[a-zA-Z] ]]; then
            echo "is-prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a pre-release version"
          else
            echo "is-prerelease=false" >> $GITHUB_OUTPUT
            echo "This is a stable release"
          fi
      
      - name: Validate version format
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$ ]]; then
            echo "Error: Invalid semantic version format: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]"
            exit 1
          fi
          echo "Version format is valid"
      
      - name: Check CHANGELOG entry
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if ! grep -q "\[$VERSION\]" CHANGELOG.md; then
            echo "Warning: No CHANGELOG entry found for version $VERSION"
            echo "Please update CHANGELOG.md before releasing"
            exit 1
          fi
          echo "CHANGELOG entry found for version $VERSION"

  # Job 2: Run all tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run type checking
        run: npm run typecheck
      
      - name: Run linting
        run: npm run lint
      
      - name: Run all tests
        run: npm run test:coverage
      
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # Job 3: Build and bundle the action
  build:
    name: Build Action
    runs-on: ubuntu-latest
    needs: [validate, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build action
        run: npm run build
      
      - name: Verify build artifacts
        run: |
          if [ ! -f "dist/index.js" ]; then
            echo "Error: dist/index.js not found"
            exit 1
          fi
          if [ ! -f "dist/licenses.txt" ]; then
            echo "Warning: dist/licenses.txt not found"
          fi
          echo "Build artifacts verified"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  # Job 4: Generate release notes
  release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      notes: ${{ steps.generate-notes.outputs.notes }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract CHANGELOG section
        id: extract-changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          # Extract the section for this version from CHANGELOG.md
          awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '$d' > release-notes.md
          
          # Check if we got any content
          if [ ! -s release-notes.md ]; then
            echo "Warning: Could not extract CHANGELOG section for version $VERSION"
            echo "## What's Changed" > release-notes.md
            echo "" >> release-notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release-notes.md
          fi
          
          cat release-notes.md
      
      - name: Generate release notes
        id: generate-notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          # Start with CHANGELOG content
          cat release-notes.md > full-release-notes.md
          
          # Add installation instructions
          echo "" >> full-release-notes.md
          echo "## Installation" >> full-release-notes.md
          echo "" >> full-release-notes.md
          echo "### Using the latest major version (recommended)" >> full-release-notes.md
          echo '```yaml' >> full-release-notes.md
          echo "- uses: ${{ github.repository }}@v${{ needs.validate.outputs.major-version }}" >> full-release-notes.md
          echo '```' >> full-release-notes.md
          echo "" >> full-release-notes.md
          echo "### Using a specific version" >> full-release-notes.md
          echo '```yaml' >> full-release-notes.md
          echo "- uses: ${{ github.repository }}@v$VERSION" >> full-release-notes.md
          echo '```' >> full-release-notes.md
          echo "" >> full-release-notes.md
          echo "## Documentation" >> full-release-notes.md
          echo "" >> full-release-notes.md
          echo "- [README](README.md) - Complete usage guide" >> full-release-notes.md
          echo "- [CHANGELOG](CHANGELOG.md) - Full version history" >> full-release-notes.md
          echo "- [Examples](.github/workflows/examples/) - Example workflows" >> full-release-notes.md
          
          # Save to output
          {
            echo 'notes<<EOF'
            cat full-release-notes.md
            echo EOF
          } >> $GITHUB_OUTPUT
      
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: full-release-notes.md
          retention-days: 1

  # Job 5: Create GitHub release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, test, build, release-notes]
    outputs:
      upload-url: ${{ steps.create-release.outputs.upload_url }}
      release-id: ${{ steps.create-release.outputs.id }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      
      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
      
      - name: Create GitHub Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          release_name: v${{ needs.validate.outputs.version }}
          body_path: full-release-notes.md
          draft: false
          prerelease: ${{ needs.release-notes.outputs.is-prerelease == 'true' }}
      
      - name: Upload dist artifact to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_path: ./dist/index.js
          asset_name: index.js
          asset_content_type: application/javascript

  # Job 6: Update major version tag
  update-major-tag:
    name: Update Major Version Tag
    runs-on: ubuntu-latest
    needs: [validate, release]
    if: needs.validate.outputs.is-prerelease == 'false'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Update major version tag
        run: |
          MAJOR_VERSION="${{ needs.validate.outputs.major-version }}"
          VERSION="${{ needs.validate.outputs.version }}"
          
          echo "Updating v$MAJOR_VERSION tag to point to v$VERSION"
          
          # Delete the major version tag if it exists
          git tag -d "v$MAJOR_VERSION" 2>/dev/null || true
          git push origin ":refs/tags/v$MAJOR_VERSION" 2>/dev/null || true
          
          # Create new major version tag pointing to this release
          git tag -a "v$MAJOR_VERSION" -m "Update v$MAJOR_VERSION to v$VERSION"
          git push origin "v$MAJOR_VERSION"
          
          echo "Successfully updated v$MAJOR_VERSION tag"
      
      - name: Create major version update comment
        run: |
          MAJOR_VERSION="${{ needs.validate.outputs.major-version }}"
          VERSION="${{ needs.validate.outputs.version }}"
          
          echo "Major version tag v$MAJOR_VERSION now points to v$VERSION"
          echo "Users can reference this action using:"
          echo "  - ${{ github.repository }}@v$MAJOR_VERSION (tracks latest v$MAJOR_VERSION.x.x)"
          echo "  - ${{ github.repository }}@v$VERSION (pinned to this specific version)"

  # Job 7: Publish to GitHub Marketplace
  marketplace:
    name: Publish to Marketplace
    runs-on: ubuntu-latest
    needs: [validate, release, update-major-tag]
    if: needs.validate.outputs.is-prerelease == 'false'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate action.yml for marketplace
        run: |
          # Check required fields for marketplace
          if ! grep -q "^name:" action.yml; then
            echo "Error: action.yml missing 'name' field"
            exit 1
          fi
          
          if ! grep -q "^description:" action.yml; then
            echo "Error: action.yml missing 'description' field"
            exit 1
          fi
          
          if ! grep -q "^branding:" action.yml; then
            echo "Warning: action.yml missing 'branding' section (recommended for marketplace)"
          fi
          
          echo "action.yml is valid for marketplace publication"
      
      - name: Marketplace publication info
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          echo "‚úÖ Release v$VERSION is ready for GitHub Marketplace"
          echo ""
          echo "The action will be automatically published to GitHub Marketplace because:"
          echo "  1. This is a public repository"
          echo "  2. The release is tagged with a semantic version (v$VERSION)"
          echo "  3. The action.yml file is valid"
          echo "  4. This is not a pre-release"
          echo ""
          echo "Users can find this action at:"
          echo "  https://github.com/marketplace/actions/$(echo '${{ github.repository }}' | cut -d'/' -f2)"
          echo ""
          echo "To complete marketplace publication:"
          echo "  1. Ensure the repository is public"
          echo "  2. Visit the Marketplace tab in your repository"
          echo "  3. Review and publish the release if needed"

  # Job 8: Post-release validation
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    needs: [validate, release, update-major-tag]
    
    steps:
      - name: Checkout code at release tag
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.validate.outputs.version }}
      
      - name: Verify release tag
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          CURRENT_TAG=$(git describe --tags --exact-match)
          
          if [ "$CURRENT_TAG" != "v$VERSION" ]; then
            echo "Error: Tag mismatch. Expected v$VERSION, got $CURRENT_TAG"
            exit 1
          fi
          
          echo "‚úÖ Release tag verified: $CURRENT_TAG"
      
      - name: Verify major version tag
        if: needs.validate.outputs.is-prerelease == 'false'
        run: |
          MAJOR_VERSION="${{ needs.validate.outputs.major-version }}"
          VERSION="${{ needs.validate.outputs.version }}"
          
          # Fetch the major version tag
          git fetch origin "refs/tags/v$MAJOR_VERSION:refs/tags/v$MAJOR_VERSION" || true
          
          # Check if major version tag points to this release
          MAJOR_TAG_COMMIT=$(git rev-list -n 1 "v$MAJOR_VERSION" 2>/dev/null || echo "")
          RELEASE_TAG_COMMIT=$(git rev-list -n 1 "v$VERSION")
          
          if [ "$MAJOR_TAG_COMMIT" = "$RELEASE_TAG_COMMIT" ]; then
            echo "‚úÖ Major version tag v$MAJOR_VERSION points to v$VERSION"
          else
            echo "‚ö†Ô∏è  Major version tag v$MAJOR_VERSION does not point to v$VERSION yet"
            echo "This may take a moment to propagate"
          fi
      
      - name: Test action can be referenced
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          MAJOR_VERSION="${{ needs.validate.outputs.major-version }}"
          
          echo "‚úÖ Action can be referenced as:"
          echo "   - ${{ github.repository }}@v$VERSION"
          if [ "${{ needs.validate.outputs.is-prerelease }}" = "false" ]; then
            echo "   - ${{ github.repository }}@v$MAJOR_VERSION"
          fi

  # Job 9: Notify on success
  notify-success:
    name: Release Complete
    runs-on: ubuntu-latest
    needs: [validate, release, update-major-tag, marketplace, validate-release]
    if: success()
    
    steps:
      - name: Release summary
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          MAJOR_VERSION="${{ needs.validate.outputs.major-version }}"
          IS_PRERELEASE="${{ needs.validate.outputs.is-prerelease }}"
          
          echo "üéâ Release v$VERSION completed successfully!"
          echo ""
          echo "üì¶ Release Details:"
          echo "   - Version: v$VERSION"
          echo "   - Major Version Tag: v$MAJOR_VERSION"
          echo "   - Pre-release: $IS_PRERELEASE"
          echo "   - Release URL: ${{ needs.release.outputs.upload-url }}"
          echo ""
          echo "üìö Next Steps:"
          echo "   1. Verify the release at: https://github.com/${{ github.repository }}/releases/tag/v$VERSION"
          if [ "$IS_PRERELEASE" = "false" ]; then
            echo "   2. Check GitHub Marketplace: https://github.com/marketplace/actions/$(echo '${{ github.repository }}' | cut -d'/' -f2)"
          fi
          echo "   3. Update documentation if needed"
          echo "   4. Announce the release to users"
          echo ""
          echo "‚úÖ All release tasks completed!"

  # Job 10: Notify on failure
  notify-failure:
    name: Release Failed
    runs-on: ubuntu-latest
    needs: [validate, test, build, release-notes, release, update-major-tag, marketplace, validate-release]
    if: failure()
    
    steps:
      - name: Failure summary
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          echo "‚ùå Release v$VERSION failed!"
          echo ""
          echo "Please check the workflow logs to identify the issue:"
          echo "   - Validation: ${{ needs.validate.result }}"
          echo "   - Tests: ${{ needs.test.result }}"
          echo "   - Build: ${{ needs.build.result }}"
          echo "   - Release Notes: ${{ needs.release-notes.result }}"
          echo "   - Release: ${{ needs.release.result }}"
          echo "   - Update Major Tag: ${{ needs.update-major-tag.result }}"
          echo "   - Marketplace: ${{ needs.marketplace.result }}"
          echo "   - Validate Release: ${{ needs.validate-release.result }}"
          echo ""
          echo "Common issues:"
          echo "   - Missing CHANGELOG entry for version $VERSION"
          echo "   - Test failures"
          echo "   - Build errors"
          echo "   - Invalid version format"
          echo ""
          echo "After fixing the issue, delete the tag and try again:"
          echo "   git tag -d v$VERSION"
          echo "   git push origin :refs/tags/v$VERSION"
